generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters", "fullTextIndex", "fullTextSearch"]
}

generator kyselyServerSide {
  provider            = "prisma-kysely"
  camelCase           = true
  output              = "../src/lib/models/types"
  fileName            = "database.types.ts"
  decimalTypeOverride = "number"
  bigIntTypeOverride  = "number"
}

datasource db {
  provider     = "mysql"
  url          = env("DATABASE_URL")
  relationMode = "prisma"
}

model Category {
  id String @id @default(cuid()) @db.VarChar(30)

  courses Course[]

  imgHref String @db.Text
  title   String @unique
}

model Course {
  id String @id @default(cuid()) @db.VarChar(30)

  category           Category         @relation(fields: [categoryId], references: [id], onUpdate: Cascade, onDelete: Restrict)
  courseProgressions CourseProgress[]
  instructor         User             @relation(fields: [instructorId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  lessons            Lesson[]
  organization       Organization?    @relation(fields: [organizationId], references: [id], onUpdate: Cascade, onDelete: SetNull)

  categoryId           String
  currentPrice         Decimal
  description          String  @db.Text
  difficulty           String
  estimatedTimeHours   Int
  estimatedTimeMinutes Int
  imgHref              String
  instructorId         String
  lessonCount          Int
  organizationId       String?
  originalPrice        Decimal
  ratingAverage        Float
  ratingCount          Int
  title                String  @db.Text

  @@index([categoryId])
  @@index([instructorId])
  @@index([organizationId])
  @@fulltext([title])
  @@fulltext([title, description])
}

enum ContentType {
  VIDEO
  TEXT
  QUIZ
}

model CourseContent {
  id String @id @default(cuid()) @db.VarChar(30)

  contentType ContentType

  authorId String
  content  Json
  lessonId String?
  Lesson   Lesson? @relation(fields: [lessonId], references: [id])

  @@index([authorId])
  @@index([lessonId])
}

model CourseProgress {
  course Course @relation(fields: [courseId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onUpdate: Cascade, onDelete: Cascade)

  courseId         String
  lessonsCompleted Int
  userId           String

  @@id([userId, courseId])
  @@index([courseId])
  @@index([userId])
}

model Lesson {
  id String @id @default(cuid()) @db.VarChar(30)

  course         Course?         @relation(fields: [courseId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  courseContents CourseContent[]

  courseId String?
  title    String

  @@index([courseId])
}

model Organization {
  id String @id @default(cuid()) @db.VarChar(30)

  courses Course[]

  description String? @db.Text
  name        String  @db.Text
  User        User[]
}

model User {
  id String @id @default(cuid()) @db.VarChar(30)

  AuthUser           AuthUser?        @relation(fields: [authUserId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  courses            Course[]
  courseProgressions CourseProgress[]
  organization       Organization?    @relation(fields: [organizationId], references: [id], onUpdate: Cascade, onDelete: SetNull)
  permissions        Permission[]

  areaCode       String? @db.VarChar(5)
  authUserId     String? @unique @db.VarChar(30)
  bio            String? @db.Text
  city           String? @db.Text
  countryCode    String? @db.VarChar(5)
  email          String  @unique
  name           String  @db.Text
  organizationId String?
  phoneNumber    String? @db.VarChar(15)
  photoUrl       String? @db.Text
  role           String
  state          String?

  @@index([authUserId])
  @@index([organizationId])
}

enum KeyType {
  CREDENTIAL_HASH
  OAUTH_TOKEN
}

model AuthKey {
  id String @id @default(cuid()) @db.VarChar(30)

  authUser AuthUser @relation(fields: [authUserId], references: [id], onUpdate: Cascade, onDelete: Cascade)

  authUserId String  @db.VarChar(30)
  keyValue   String
  keyType    KeyType

  @@index([authUserId])
}

model AuthSession {
  id String @id @default(cuid()) @db.VarChar(30)

  authUser AuthUser @relation(fields: [authUserId], references: [id], onUpdate: Cascade, onDelete: Cascade)

  authUserId     String   @db.VarChar(30)
  expirationDate DateTime

  @@index([authUserId])
}

model AuthUser {
  id String @id @default(cuid()) @db.VarChar(30)

  authKeys     AuthKey[]
  authSessions AuthSession[]
  user         User?

  email String @unique
}

model CsrfToken {
  token String @id @default(cuid()) @db.VarChar(30)

  expirationDate DateTime
}

enum PermissionType {
  READ
  WRITE
  DELETE
}

enum ResourceType {
  COURSE
  LESSON
  USER
}

model Permission {
  id String @id @default(cuid()) @db.VarChar(30)

  user User @relation(fields: [userId], references: [id], onUpdate: Cascade, onDelete: Cascade)

  permissionType PermissionType
  resourceId     String // Eventually shift this to another table
  resourceType   ResourceType
  userId         String

  @@index([userId])
}
